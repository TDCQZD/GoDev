<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600243 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 16pt;
    }
  </style>
</head>
<body>
<a name="943"/>
<h1>04_会话控制</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2018/9/7 16:54</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2018/9/7 17:16</i></td></tr>
<tr><td><b>作者：</b></td><td><i>韩延兵</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><div>1.Cookie</div><ul><li><div>Cookie就是服务器发送给浏览器并且保存在浏览器上的一段区分不同用户的信息</div></li><li><div>Cookie的运行原理</div></li><ul><li><div>1）第一次向服务器发送请求时在服务器端创建Cookie</div></li><li><div>2）将在服务器端创建的Cookie以响应头的方式发送给浏览器</div></li><li><div>3）以后再发送请求浏览器就会携带着该Cookie</div></li><li><div>4）服务器得到Cookie之后根据Cookie的信息来区分不同的用户</div></li></ul><li><div>创建Cookie</div></li><ul><li><div>1)通过net/http包的Cookie结构体创建Cookie</div></li><li><div>2)通过响应头将Cookie发送给浏览器</div></li></ul></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//setCookie 添加Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(86, 156, 214);">func</span> <span style="color: rgb(220, 220, 170);">setCookie</span><span style="color: rgb(212, 212, 212);">(w http.ResponseWriter, r</span> <span style="color: rgb(212, 212, 212);">*</span><span style="color: rgb(212, 212, 212);">http.Request) {</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//创建Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><font color="#9E00F3">cookie := http.Cookie{</font></font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        Name: &quot;user&quot;,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        Value: &quot;admin&quot;,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        HttpOnly: true,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">    }</font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//将Cookie发送给浏览器</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">   </span><font color="#9E00F3"> w.Header().Set(&quot;Set-Cookie&quot;, cookie.String())</font></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">}</font></span></div></div><ul><li><div>如果一次向服务器发送两个Cookie第二个Cookie使用Header的Add方法</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//setCookie 添加Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(86, 156, 214);">func</span> <span style="color: rgb(220, 220, 170);">setCookie</span><span style="color: rgb(212, 212, 212);">(w http.ResponseWriter, r</span> <span style="color: rgb(212, 212, 212);">*</span><span style="color: rgb(212, 212, 212);">http.Request) {</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//创建Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(156, 220, 254);">cookie</span> <span style="color: rgb(212, 212, 212);">:=</span> <span style="color: rgb(212, 212, 212);">http.Cookie{</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Name:</span> <span style="color: rgb(206, 145, 120);">&quot;user&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Value:</span> <span style="color: rgb(206, 145, 120);">&quot;admin&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        HttpOnly:</span> <span style="color: rgb(86, 156, 214);">true</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">    }</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><font color="#9E00F3">cookie2 := http.Cookie{</font></font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        Name: &quot;user2&quot;,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        Value: &quot;admin2&quot;,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">        HttpOnly: true,</font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">    }</font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//将Cookie发送给浏览器</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    w.</span><span style="color: rgb(220, 220, 170);">Header</span><span style="color: rgb(212, 212, 212);">().</span><span style="color: rgb(220, 220, 170);">Set</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">&quot;Set-Cookie&quot;</span><span style="color: rgb(212, 212, 212);">, cookie.</span><span style="color: rgb(220, 220, 170);">String</span><span style="color: rgb(212, 212, 212);">())</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//添加第二个Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">   </span><font color="#9E00F3"> w.Header().Add(&quot;Set-Cookie&quot;, cookie2.String())</font></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">}</font></span></div></div><ul><li><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">还可以通过http的SetCookie函数快速添加Cookie</span></div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//setCookie 添加Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(86, 156, 214);">func</span> <span style="color: rgb(220, 220, 170);">setCookie</span><span style="color: rgb(212, 212, 212);">(w http.ResponseWriter, r</span> <span style="color: rgb(212, 212, 212);">*</span><span style="color: rgb(212, 212, 212);">http.Request) {</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//创建Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(156, 220, 254);">cookie</span> <span style="color: rgb(212, 212, 212);">:=</span> <span style="color: rgb(212, 212, 212);">http.Cookie{</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Name:</span> <span style="color: rgb(206, 145, 120);">&quot;user&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Value:</span> <span style="color: rgb(206, 145, 120);">&quot;admin&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        HttpOnly:</span> <span style="color: rgb(86, 156, 214);">true</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">    }</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(156, 220, 254);">cookie2</span> <span style="color: rgb(212, 212, 212);">:=</span> <span style="color: rgb(212, 212, 212);">http.Cookie{</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Name:</span> <span style="color: rgb(206, 145, 120);">&quot;user2&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Value:</span> <span style="color: rgb(206, 145, 120);">&quot;admin2&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        HttpOnly:</span> <span style="color: rgb(86, 156, 214);">true</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">    }</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//将Cookie发送给浏览器</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//直接调用http的SetCookie函数设置Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><font color="#D4D4D4">    </font><font color="#9E00F3">http.SetCookie(w, &amp;cookie)</font></font></div><div><font color="#9E00F3" face="Consolas" style="font-size: 16pt;">    http.SetCookie(w, &amp;cookie2)</font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">}</font></span></div></div><ul><li><div>设置Cookie的有效时间</div></li><ul><li><div>通过Cookie的MaxAge字段设置Cookie的有效时间，单位秒</div></li><li><div>例如：设置Cookie在60秒后失效</div></li></ul></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//创建Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(156, 220, 254);">cookie</span> <span style="color: rgb(212, 212, 212);">:=</span> <span style="color: rgb(212, 212, 212);">http.Cookie{</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Name:</span> <span style="color: rgb(206, 145, 120);">&quot;user&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        Value:</span> <span style="color: rgb(206, 145, 120);">&quot;admin&quot;</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        HttpOnly:</span> <span style="color: rgb(86, 156, 214);">true</span><span style="color: rgb(212, 212, 212);">,</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">        </span><font color="#9E00F3">MaxAge: 60,</font></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">    }</font></span></div></div><ul><li><div>获取Cookie</div></li><ul><li><div>每次发送请求通过请求头携带Cookie，所以我们可以通过Request结构的Header字段获取所有Cookie</div></li></ul></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//getCookies 获取Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(86, 156, 214);">func</span> <span style="color: rgb(220, 220, 170);">getCookies</span><span style="color: rgb(212, 212, 212);">(w http.ResponseWriter, r</span> <span style="color: rgb(212, 212, 212);">*</span><span style="color: rgb(212, 212, 212);">http.Request) {</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//获取请求头中所有的Cookie</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">   </span><font color="#9E00F3"> cookies := r.Header[&quot;Cookie&quot;]</font></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    fmt.</span><span style="color: rgb(220, 220, 170);">Println</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">&quot;得到的Cookie有：&quot;</span><span style="color: rgb(212, 212, 212);">, cookies)</span></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">}</font></span></div></div><ul><li><div>如果只获取一个Cookie，我们可以通过Request结构的Cookie方法快速获取</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(106, 153, 85);"><font face="Consolas" style="font-size: 16pt;">//getCookies 获取Cookie</font></span></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(86, 156, 214);">func</span> <span style="color: rgb(220, 220, 170);">getCookies</span><span style="color: rgb(212, 212, 212);">(w http.ResponseWriter, r</span> <span style="color: rgb(212, 212, 212);">*</span><span style="color: rgb(212, 212, 212);">http.Request) {</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><span style="color: rgb(106, 153, 85);">//如果想得到某一个Cookie，可以直接调用Cookie方法</span></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    </span><font color="#9E00F3">cookie, _ := r.Cookie(&quot;user&quot;)</font></font></div><div><font face="Consolas" style="font-size: 16pt;"><span style="color: rgb(212, 212, 212);">    fmt.</span><span style="color: rgb(220, 220, 170);">Println</span><span style="color: rgb(212, 212, 212);">(</span><span style="color: rgb(206, 145, 120);">&quot;得到的Cookie是：&quot;</span><span style="color: rgb(212, 212, 212);">, cookie)</span></font></div><div><span style="color: rgb(212, 212, 212);"><font face="Consolas" style="font-size: 16pt;">}</font></span></div></div><ul><li><div>Cookie的用途</div></li><ul><li><div>广告推荐</div></li><li><div>免登录</div></li></ul><li><div>Cookie的缺陷</div></li><ul><li><div>Cookie是明文的，不安全</div></li><li><div>不同的浏览器对Cookie的大小和数量有不同的限制</div></li><li><div>每次发送请求携带过多的Cookie费流量</div></li><li><div>Cookie的Value字段是string类型，只能保存string类型的值</div></li></ul></ul><div>2.Session</div><ul><li><div>Session的作用就是在服务器端保存一些用户的数据</div></li><li><div>Session的运行原理</div></li><ul><li><div>1）第一次向服务器发送请求时创建Session，给它设置一个全球唯一的ID（可以通过UUID生成）</div></li><li><div>2）创建一个Cookie，将Cookie的Value设置为Session的ID值，并将Cookie发送给浏览器</div></li><li><div>3）以后再发送请求浏览器就会携带着该Cookie</div></li><li><div>4）服务器获取Cookie并根据它的Value值找到服务器中对应的Session，也就知道了请求是那个用户发的</div></li></ul></ul><div><br/></div></div></span>
</div></body></html> 